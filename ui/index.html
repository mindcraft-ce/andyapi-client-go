<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AndyAPI Local Client</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0f1115;--panel:#141922;--muted:#94a3b8;--text:#e2e8f0;--primary:#3b82f6;--border:#233044;--accent:#22c55e;--warn:#f59e0b;--danger:#ef4444
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:linear-gradient(180deg,#0b0e13,#0f1115 120px) fixed;color:var(--text)}
    header{position:sticky;top:0;z-index:10;background:#121722cc;backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--border)}
    .title{font-weight:700}
  .pill{padding:2px 8px;border:1px solid var(--border);border-radius:8px;font-size:12px;color:var(--muted)}
  .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border);}
  .badge.gray{background:#374151;color:#e5e7eb}
  .badge.green{background:#065f46;color:#a7f3d0}
  .badge.red{background:#7f1d1d;color:#fecaca}
    .btn{background:#1b2230;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--primary);border-color:var(--primary)}
    .btn.danger{background:#b91c1c;border-color:#b91c1c}
    main{max-width:1120px;margin:0 auto;padding:20px}
    .tabs{display:flex;gap:8px;border-bottom:1px solid var(--border)}
    .tab{padding:10px 12px;border:1px solid var(--border);border-bottom:none;border-radius:8px 8px 0 0;background:#121722;color:var(--muted);cursor:pointer}
    .tab.active{color:var(--text);background:#161c26}
    .panel{border:1px solid var(--border);border-radius:0 8px 8px 8px;background:#121722;padding:16px;margin-bottom:18px}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea{width:100%;margin-top:6px;padding:10px;background:#0f141d;border:1px solid var(--border);border-radius:8px;color:var(--text)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left}
    th{font-size:12px;color:var(--muted);text-transform:uppercase}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}
    .toast{position:fixed;bottom:16px;right:16px;background:#1b2230;border:1px solid var(--border);padding:10px 12px;border-radius:8px;display:none}
    .hint{color:var(--muted);font-size:12px}
    .stat-card{background:#0f141d;border:1px solid var(--border);border-radius:8px;padding:16px;text-align:center}
    .stat-card .value{font-size:28px;font-weight:700;color:var(--text)}
    .stat-card .label{font-size:12px;color:var(--muted);margin-top:4px}
    .chart-container{position:relative;height:250px;margin-top:16px}
    .stats-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));margin-bottom:16px}
  </style>
</head>
<body>
  <header>
    <div class="row">
      <div class="title">AndyAPI Local Client</div>
      <div id="statusBadge" class="badge gray">never connected</div>
      <div id="clientId" class="pill">id: …</div>
      <div id="wsUrl" class="pill">ws: …</div>
    </div>
    <div class="row">
      <button id="btnConnect" class="btn primary">Connect to AndyAPI</button>
      <button id="btnDisconnect" class="btn" style="display:none">Disconnect from AndyAPI</button>
      <button id="btnSave" class="btn primary">Save</button>
    </div>
  </header>
  <main>
    <div class="tabs">
      <div class="tab active" data-tab="connection">Connection</div>
      <div class="tab" data-tab="models">Models</div>
      <div class="tab" data-tab="stats">Statistics</div>
      <div class="tab" data-tab="about">About</div>
    </div>

    <section id="tab-connection" class="panel">
      <h3>Connection</h3>
      <div class="grid">
        <div>
          <label>Andy API Base URL</label>
          <input id="andy_api_url" placeholder="https://andy.mindcraft-ce.com/api/">
          <div class="hint">WS derived as ws(s)://host/ws</div>
        </div>
        <div>
          <label>Provider Name</label>
          <input id="provider" placeholder="my-provider">
          <div class="hint">Optional, if you want to provide the provider DEFAULT: local-llm</div>
        </div>
        <div>
          <label>Heartbeat Interval (sec)</label>
          <input id="heartbeat" type="number" min="5" value="30">
        </div>
        <div>
          <label>Reconnect Max Backoff (sec)</label>
          <input id="reconnect" type="number" min="5" value="30">
        </div>
        <div>
          <label>Request Timeout (sec)</label>
          <input id="request_timeout" type="number" min="10" value="60">
          <div class="hint">Timeout for local API completion requests</div>
        </div>
      </div>

      <h4 style="margin-top:20px;margin-bottom:10px">Local Endpoints</h4>
      <table id="endpointsTable">
        <thead><tr><th>ID</th><th>URL</th><th>Key</th><th>Headers</th><th>Actions</th></tr></thead>
        <tbody id="endpointsBody"></tbody>
      </table>
      <div class="row" style="margin-top:10px;align-items:flex-end">
        <div style="width:150px"><label>ID</label><input id="new_ep_id" placeholder="e.g. ollama"></div>
        <div style="flex:1"><label>URL</label><input id="new_ep_url" placeholder="http://localhost:11434"></div>
        <div style="flex:1"><label>Key</label><input id="new_ep_key" placeholder="Optional"></div>
        <button id="btnAddEndpoint" class="btn" style="margin-top:22px">Add</button>
      </div>
    </section>

    <section id="tab-models" class="panel" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Models</h3>
        <div class="row">
          <button id="btnScanModels" class="btn">Scan from Local API</button>
        </div>
      </div>
      <div id="modelsEmpty" class="hint" style="margin:8px 0">No models yet. Click &quot;Scan from Local API&quot; to populate from /v1/models.</div>
      <table id="modelsTable" style="display:none;margin-top:8px">
        <thead>
          <tr>
            <th>Name</th>
            <th>Context</th>
            <th>Concurrency</th>
            <th>Embed</th>
            <th>Vision</th>
            <th>Enabled</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="modelsBody"></tbody>
      </table>

      <div id="modelEditor" class="panel" style="margin-top:14px;display:none">
        <h4 id="editorTitle">New Model</h4>
        <div class="grid">
          <div>
            <label>Name (External ID)</label>
            <input id="m_name" placeholder="model-id">
          </div>
          <div>
            <label>Internal ID (Optional)</label>
            <input id="m_internal_id" placeholder="Same as Name if empty">
          </div>
          <div>
            <label>Endpoint</label>
            <select id="m_endpoint"></select>
          </div>
          <div style="grid-column: 1 / -1;">
            <label>System Prompt (Optional)</label>
            <textarea id="m_sys_prompt" rows="3" style="width:100%;margin-top:6px;padding:10px;background:#0f141d;border:1px solid var(--border);border-radius:8px;color:var(--text)"></textarea>
          </div>
          <div>
            <label>Max Completion Tokens</label>
            <input id="m_ctx" type="number" min="1" value="4096">
          </div>
          <div>
            <label>Concurrent Connections</label>
            <input id="m_cc" type="number" min="1" value="1">
          </div>
          <div>
            <label><input id="m_embed" type="checkbox"> Supports Embedding</label>
          </div>
          <div>
            <label><input id="m_vision" type="checkbox"> Supports Vision</label>
          </div>
          <div style="grid-column: 1 / -1;">
            <label>Extra Headers (JSON, optional)</label>
            <input id="m_extra_headers" placeholder='{"X-Custom-Header": "value"}'>
            <div class="hint">Model-specific headers override endpoint headers</div>
          </div>
          <div style="grid-column: 1 / -1;">
            <label>Extra Params (JSON, optional)</label>
            <input id="m_extra_params" placeholder='{"temperature": 0.7}'>
            <div class="hint">Extra parameters to include in API requests</div>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button id="btnSaveModel" class="btn primary">Save Model</button>
          <button id="btnCancelModel" class="btn">Cancel</button>
        </div>
      </div>
    </section>

    <section id="tab-stats" class="panel" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:16px">
        <h3 style="margin:0">Statistics</h3>
        <div class="row">
          <button id="btnRefreshStats" class="btn">Refresh</button>
          <button id="btnResetStats" class="btn danger">Reset Stats</button>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="value" id="statUptime">0s</div>
          <div class="label">Uptime</div>
        </div>
        <div class="stat-card">
          <div class="value" id="statTotal">0</div>
          <div class="label">Total Requests</div>
        </div>
        <div class="stat-card">
          <div class="value" id="statSuccess">0</div>
          <div class="label">Successful</div>
        </div>
        <div class="stat-card">
          <div class="value" id="statFailed">0</div>
          <div class="label">Failed</div>
        </div>
        <div class="stat-card">
          <div class="value" id="statSuccessRate">-</div>
          <div class="label">Success Rate</div>
        </div>
      </div>

      <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <div>
          <h4>Requests Over Time (24h)</h4>
          <div class="chart-container">
            <canvas id="hourlyChart"></canvas>
          </div>
        </div>
        <div>
          <h4>Requests by Model</h4>
          <div class="chart-container">
            <canvas id="modelChart"></canvas>
          </div>
        </div>
      </div>

      <div style="margin-top:20px">
        <h4>Model Performance</h4>
        <table id="modelStatsTable">
          <thead>
            <tr>
              <th>Model</th>
              <th>Total</th>
              <th>Success</th>
              <th>Failed</th>
              <th>Avg Duration</th>
              <th>Tokens/sec</th>
            </tr>
          </thead>
          <tbody id="modelStatsBody"></tbody>
        </table>
      </div>

      <div style="margin-top:20px">
        <h4>Recent Requests</h4>
        <table id="recentRequestsTable">
          <thead>
            <tr>
              <th>Time</th>
              <th>Model</th>
              <th>Duration</th>
              <th>Tokens In/Out</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="recentRequestsBody"></tbody>
        </table>
      </div>
    </section>

    <section id="tab-about" class="panel" style="display:none">
      <h3>About</h3>
      <p class="hint">This client connects your local/provider models to the Andy API server via WebSocket and exposes a small UI to manage configuration.</p>
      <h4>Features</h4>
      <ul class="hint">
        <li>Request timeout configuration</li>
        <li>Config hot reload (changes detected every 5 seconds)</li>
        <li>Extra headers/params per endpoint or per model</li>
        <li>Local statistics with charts</li>
      </ul>
    </section>
  </main>
  <div id="toast" class="toast"></div>
  <script>
    const $ = s => document.querySelector(s);
    const show = el => el.style.display = '';
    const hide = el => el.style.display = 'none';
    const toast = (m) => { const t=$('#toast'); t.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none', 2200)};

    // Tabs
    document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      ['connection','models','stats','about'].forEach(name => hide($('#tab-'+name)));
      show($('#tab-'+t.dataset.tab));
      if(t.dataset.tab === 'stats') refreshStats();
    }));

    // State
    let cfg = null; let initial = false; let editIndex = -1;
    let hourlyChart = null; let modelChart = null;

    function wsFrom(base){ if(!base) return ''; base = base.trim().replace(/\/$/,'');
      if(base.startsWith('ws')) return base.endsWith('/ws')?base:base+'/ws';
      if(base.startsWith('http://')) return 'ws://'+base.slice(7)+'/ws';
      if(base.startsWith('https://')) return 'wss://'+base.slice(8)+'/ws';
      return 'ws://'+base+'/ws'; }

    async function loadState(){ try{ const r = await fetch('/api/state'); if(r.ok){ const j = await r.json(); initial = j.initial_setup; } }catch(e){} }
    async function loadCfg(){ const r = await fetch('/config'); cfg = await r.json(); renderAll(); }

    function renderAll(){
      // Connection
      $('#andy_api_url').value = cfg.andy_api_url||'';
      $('#provider').value = cfg.provider||'';
      $('#heartbeat').value = cfg.heartbeat_interval||30;
      $('#reconnect').value = cfg.reconnect_max_backoff||30;
      $('#request_timeout').value = cfg.request_timeout||60;
      $('#wsUrl').textContent = 'ws: '+ (cfg.andy_api_url? wsFrom(cfg.andy_api_url): 'ws://localhost:8080/ws');

      // Endpoints
      const eps = cfg.endpoints||[];
      const epBody = $('#endpointsBody');
      epBody.innerHTML = '';
      eps.forEach((ep,i)=>{
        const tr = document.createElement('tr');
        const hasHeaders = ep.extra_headers && Object.keys(ep.extra_headers).length > 0;
        tr.innerHTML = `<td>${ep.id}</td><td>${ep.url}</td><td>${ep.api_key?'***':''}</td>
          <td>${hasHeaders ? '✔' : ''}</td>
          <td>
            <button class="btn" data-scan-ep="${i}">Scan</button>
            <button class="btn" data-edit-ep="${i}">Edit</button>
            <button class="btn danger" data-del-ep="${i}">Del</button>
          </td>`;
        epBody.appendChild(tr);
      });

      // Models
      const models = cfg.models||[];
      const empty = $('#modelsEmpty'); const table = $('#modelsTable'); const body = $('#modelsBody');
      body.innerHTML = '';
      if(models.length === 0){ show(empty); hide(table);} else { hide(empty); show(table); }
      models.forEach((m,i)=>{
        const tr = document.createElement('tr');
        const enabled = m.enabled? 'checked' : '';
        tr.innerHTML = `<td>${m.name||''}</td><td>${m.max_completion_tokens||0}</td><td>${m.concurrent_connections||1}</td>
                        <td>${m.supports_embedding?'✔':''}</td><td>${m.supports_vision?'✔':''}</td>
                        <td><input type="checkbox" data-enable="${i}" ${enabled}></td>
                        <td><button class="btn" data-i="${i}">Edit</button> <button class="btn danger" data-del="${i}">Delete</button></td>`;
        body.appendChild(tr);
      });
      // Client ID on header (best-effort from /health)
      fetch('/health').then(r=>r.json()).then(h=>{ $('#clientId').textContent = 'id: '+(h.client_id||'…'); });
    }

    // Table actions
    document.addEventListener('click', async (e)=>{
      const i = e.target.getAttribute('data-i');
      if(i!==null){ editIndex = parseInt(i); openEditor(cfg.models[editIndex]); }
      const del = e.target.getAttribute('data-del');
      if(del!==null){ const idx = parseInt(del); cfg.models.splice(idx,1); renderAll(); }

      // Endpoint actions
      const delEp = e.target.getAttribute('data-del-ep');
      if(delEp!==null){ cfg.endpoints.splice(parseInt(delEp),1); renderAll(); }
      
      const editEp = e.target.getAttribute('data-edit-ep');
      if(editEp!==null){
        const ep = cfg.endpoints[parseInt(editEp)];
        const headers = prompt('Extra Headers (JSON):', JSON.stringify(ep.extra_headers||{}));
        if(headers !== null){
          try { ep.extra_headers = JSON.parse(headers||'{}'); renderAll(); }
          catch(e){ toast('Invalid JSON'); }
        }
      }
      
      const scanEp = e.target.getAttribute('data-scan-ep');
      if(scanEp!==null){
          const ep = cfg.endpoints[parseInt(scanEp)];
          await scanModels(ep.url, ep.api_key, ep.id);
      }
    });
    document.addEventListener('change', (e)=>{
      const idx = e.target.getAttribute('data-enable');
      if(idx!==null){ const i = parseInt(idx); cfg.models[i].enabled = !!e.target.checked; }
    });

    $('#btnAddEndpoint').onclick = ()=>{
        const id = $('#new_ep_id').value.trim();
        const url = $('#new_ep_url').value.trim();
        const key = $('#new_ep_key').value.trim();
        if(!id || !url) { toast('ID and URL required'); return; }
        cfg.endpoints = cfg.endpoints||[];
        if(cfg.endpoints.find(e=>e.id===id)){ toast('ID already exists'); return; }
        cfg.endpoints.push({id, url, api_key: key, extra_headers: {}, extra_params: {}});
        $('#new_ep_id').value=''; $('#new_ep_url').value=''; $('#new_ep_key').value='';
        renderAll();
    };

    function openEditor(m){ 
      $('#editorTitle').textContent = (editIndex===-1? 'New' : 'Edit') + ' Model';
      $('#m_name').value = m?.name||'';
      $('#m_internal_id').value = m?.internal_id||'';
      
      // Populate endpoints
      const sel = $('#m_endpoint');
      sel.innerHTML = '';
      (cfg.endpoints||[]).forEach(ep=>{
          const opt = document.createElement('option');
          opt.value = ep.id;
          opt.textContent = ep.id + ' (' + ep.url + ')';
          sel.appendChild(opt);
      });
      sel.value = m?.endpoint_id || (cfg.endpoints?.[0]?.id || '');

      $('#m_sys_prompt').value = m?.system_prompt||'';
      $('#m_ctx').value = m?.max_completion_tokens||4096;
      $('#m_cc').value = m?.concurrent_connections||1;
      $('#m_embed').checked = !!m?.supports_embedding;
      $('#m_vision').checked = !!m?.supports_vision;
      $('#m_extra_headers').value = m?.extra_headers ? JSON.stringify(m.extra_headers) : '';
      $('#m_extra_params').value = m?.extra_params ? JSON.stringify(m.extra_params) : '';
      show($('#modelEditor')); 
    }

  // Adding is guided by scan; you can still edit scanned models below.
    $('#btnCancelModel').onclick = ()=>{ hide($('#modelEditor')); };
    $('#btnSaveModel').onclick = ()=>{
      let extraHeaders = {};
      let extraParams = {};
      try {
        const h = $('#m_extra_headers').value.trim();
        if(h) extraHeaders = JSON.parse(h);
      } catch(e) { toast('Invalid extra headers JSON'); return; }
      try {
        const p = $('#m_extra_params').value.trim();
        if(p) extraParams = JSON.parse(p);
      } catch(e) { toast('Invalid extra params JSON'); return; }

      const m = {
        name: $('#m_name').value.trim(),
        internal_id: $('#m_internal_id').value.trim(),
        endpoint_id: $('#m_endpoint').value,
        system_prompt: $('#m_sys_prompt').value.trim(),
        max_completion_tokens: parseInt($('#m_ctx').value||'0'),
        concurrent_connections: parseInt($('#m_cc').value||'1'),
        supports_embedding: $('#m_embed').checked,
        supports_vision: $('#m_vision').checked,
        enabled: (editIndex===-1 ? false : !!cfg.models[editIndex]?.enabled),
        extra_headers: extraHeaders,
        extra_params: extraParams,
      };
      if(!m.name){ toast('Model name required'); return; }
      if(editIndex===-1){ cfg.models = cfg.models||[]; cfg.models.push(m); } else { cfg.models[editIndex]=m; }
      hide($('#modelEditor')); renderAll();
    };

    // Save (initial vs update)
  $('#btnSave').onclick = async ()=>{
      try{
        const payload = {
          andy_api_url: $('#andy_api_url').value.trim(),
          provider: $('#provider').value.trim()||'provider',
          heartbeat_interval: parseInt($('#heartbeat').value||'30'),
          reconnect_max_backoff: parseInt($('#reconnect').value||'30'),
          request_timeout: parseInt($('#request_timeout').value||'60'),
          endpoints: cfg.endpoints||[],
          models: cfg.models||[],
        };
  const url = initial? '/api/save-config' : '/api/update-config';
  const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  if(!res.ok) throw new Error(await res.text());
  initial = false;
        cfg = payload; // update local
        toast('Saved');
      }catch(e){ toast('Save failed'); }
    };

    // Connection controls
    async function refreshStatus(){
      try{
        const r = await fetch('/api/status');
        if(!r.ok) return;
        const s = await r.json();
        const badge = document.getElementById('statusBadge');
        const idEl = document.getElementById('clientId');
        $('#wsUrl').textContent = 'ws: '+(s.ws_url||'…');
        const ever = !!s.ever_connected;
        const conn = !!s.connected;
        let cls = 'gray', text='never connected';
        if(ever && conn){ cls='green'; text='connected'; }
        else if(ever && !conn){ cls='red'; text='disconnected'; }
        badge.className = 'badge '+cls; badge.textContent = text;
        idEl.textContent = 'id: '+(s.client_id||'…');
        // toggle buttons
        document.getElementById('btnConnect').style.display = conn? 'none' : '';
        document.getElementById('btnDisconnect').style.display = conn? '' : 'none';
      }catch(e){}
    }
    document.getElementById('btnConnect').onclick = async ()=>{ await fetch('/api/connect', {method:'POST'}); setTimeout(refreshStatus, 200); };
    document.getElementById('btnDisconnect').onclick = async ()=>{ await fetch('/api/disconnect', {method:'POST'}); setTimeout(refreshStatus, 200); };
    setInterval(refreshStatus, 1500);

    // Scan models from local OpenAI-compatible API via server proxy (avoids CORS)
    const scanBtn = document.getElementById('btnScanModels');
    if (scanBtn) scanBtn.addEventListener('click', async ()=>{
        toast('Please use Scan button in Endpoints table');
    });

    async function scanModels(base, key, endpointId){
      if(!base){ toast('Endpoint URL required'); return; }
      try{
        const res = await fetch('/api/scan-models', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({base_url: base, api_key: key})});
        if(!res.ok){ throw new Error(await res.text()); }
        const data = await res.json();
        const newModels = data.models||[];
        // Merge logic: add if not exists
        let added = 0;
        cfg.models = cfg.models||[];
        newModels.forEach(nm => {
            if(!cfg.models.find(m=>m.name===nm.name)){
                nm.endpoint_id = endpointId;
                nm.extra_headers = {};
                nm.extra_params = {};
                cfg.models.push(nm);
                added++;
            }
        });
        renderAll();
        toast('Scanned '+added+' new models');
      }catch(e){ toast('Scan failed: '+e.message); }
    }

    // Statistics
    function formatDuration(seconds){
      if(seconds < 60) return Math.round(seconds) + 's';
      if(seconds < 3600) return Math.round(seconds/60) + 'm';
      if(seconds < 86400) return Math.round(seconds/3600) + 'h';
      return Math.round(seconds/86400) + 'd';
    }

    async function refreshStats(){
      try{
        const r = await fetch('/api/stats');
        if(!r.ok) return;
        const stats = await r.json();
        
        // Update summary cards
        $('#statUptime').textContent = formatDuration(stats.uptime_seconds||0);
        $('#statTotal').textContent = stats.total_requests||0;
        $('#statSuccess').textContent = stats.successful_requests||0;
        $('#statFailed').textContent = stats.failed_requests||0;
        const total = stats.total_requests||0;
        const success = stats.successful_requests||0;
        $('#statSuccessRate').textContent = total > 0 ? Math.round(success/total*100)+'%' : '-';

        // Update hourly chart
        const hourlyData = stats.hourly_stats||[];
        updateHourlyChart(hourlyData);

        // Update model chart
        const modelStats = stats.model_stats||{};
        updateModelChart(modelStats);

        // Update model stats table
        const msBody = $('#modelStatsBody');
        msBody.innerHTML = '';
        Object.entries(modelStats).forEach(([model, ms])=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${model}</td><td>${ms.total_requests}</td><td>${ms.successful_requests}</td>
            <td>${ms.failed_requests}</td><td>${ms.avg_duration?.toFixed(2)||0}s</td>
            <td>${ms.avg_tokens_per_second?.toFixed(1)||0}</td>`;
          msBody.appendChild(tr);
        });

        // Update recent requests table
        const rrBody = $('#recentRequestsBody');
        rrBody.innerHTML = '';
        const recent = (stats.recent_requests||[]).slice(-20).reverse();
        recent.forEach(req=>{
          const tr = document.createElement('tr');
          const time = new Date(req.timestamp).toLocaleTimeString();
          const status = req.success ? '<span style="color:var(--accent)">✔</span>' : '<span style="color:var(--danger)">✖</span>';
          tr.innerHTML = `<td>${time}</td><td>${req.model}</td><td>${req.duration?.toFixed(2)||0}s</td>
            <td>${req.tokens_in||0} / ${req.tokens_out||0}</td><td>${status}</td>`;
          rrBody.appendChild(tr);
        });
      }catch(e){ console.error('Stats refresh error:', e); }
    }

    function updateHourlyChart(data){
      const ctx = $('#hourlyChart').getContext('2d');
      const labels = data.map(h => new Date(h.hour).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
      const success = data.map(h => h.successful_requests||0);
      const failed = data.map(h => h.failed_requests||0);

      if(hourlyChart) hourlyChart.destroy();
      hourlyChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Successful', data: success, backgroundColor: '#22c55e', stack: 'stack0' },
            { label: 'Failed', data: failed, backgroundColor: '#ef4444', stack: 'stack0' }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#94a3b8' } } },
          scales: {
            x: { stacked: true, ticks: { color: '#94a3b8' }, grid: { color: '#233044' } },
            y: { stacked: true, ticks: { color: '#94a3b8' }, grid: { color: '#233044' } }
          }
        }
      });
    }

    function updateModelChart(modelStats){
      const ctx = $('#modelChart').getContext('2d');
      const labels = Object.keys(modelStats);
      const data = Object.values(modelStats).map(m => m.total_requests||0);
      const colors = ['#3b82f6','#22c55e','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#ec4899'];

      if(modelChart) modelChart.destroy();
      if(labels.length === 0) return;
      modelChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{ data, backgroundColor: colors.slice(0, labels.length) }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } }
        }
      });
    }

    $('#btnRefreshStats').onclick = refreshStats;
    $('#btnResetStats').onclick = async ()=>{
      if(!confirm('Reset all statistics?')) return;
      await fetch('/api/stats/reset', {method:'POST'});
      refreshStats();
      toast('Statistics reset');
    };

    // Init
  loadState().then(loadCfg).then(refreshStatus);
  </script>
</body>
</html>
